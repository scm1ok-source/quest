<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Квест «Перекодировка через атрибуты» — Step 1</title>

  <style>
    :root{
      --bg:#ffffff; --panel:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
      --brand:#2563eb; --brand-2:#06b6d4; --ok:#16a34a; --warn:#d97706; --err:#dc2626;
      --radius:16px; --shadow:0 10px 30px rgba(2,6,23,.08); --w: 940px;
    }
    html,body{
      margin:0; padding:0; background:var(--bg); color:var(--text);
      font:18px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    img{display:block; max-width:100%; height:auto; object-fit:contain; border-radius:12px; margin-inline:auto}
    .doc{max-width:var(--w); margin:32px auto 120px; padding:0 22px}
    .hero{background: radial-gradient(1200px 500px at 50% -160px, rgba(37,99,235,.08), transparent 60%); padding:22px 0 10px; margin-bottom:8px}
    .title{font-size: clamp(30px, 4.8vw, 44px); font-weight:800; margin:0 0 6px}
    .subtitle{color:var(--muted); font-size:16px; margin:0}

    /* TOC */
    .toc{position:sticky; top:16px; background:linear-gradient(180deg,#ffffffcc,#ffffffa8);
      border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); backdrop-filter:blur(6px); margin:20px 0 24px}
    .toc h3{margin:0 0 10px; font-size:15px; color:var(--muted); font-weight:700; text-transform:uppercase}
    .toc a{display:block; padding:8px; border-radius:12px; color:var(--text); text-decoration:none; border:1px solid transparent; font-size:17px}
    .toc a:hover{background:rgba(37,99,235,.06); border-color:rgba(37,99,235,.2)}
    .toc a.active{background:rgba(37,99,235,.1); border-color:rgba(37,99,235,.35)}

    .step{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); padding:22px 18px; margin:18px 0; box-shadow:var(--shadow)}
    .step h2{margin:0 0 12px; font-size: clamp(22px, 2.8vw, 28px)}
    .step .meta{color:var(--muted); font-size:14px; margin-bottom:10px}
    .shots{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px; margin:12px 0}
    figure{margin:0}
    figcaption{color:var(--muted); font-size:13px; margin-top:8px; text-align:center}

    .callout{border-left:5px solid var(--brand); background:rgba(37,99,235,.08); padding:12px 14px; border-radius:12px; margin:14px 0; font-size:17px}
    .callout.warn{border-left-color:var(--warn); background:rgba(217,119,6,.08)}
    .callout.ok{border-left-color:var(--ok); background:rgba(22,163,74,.08)}

    /* чекбоксы в КАЖДОМ блоке */
    .block-checks{display:grid; gap:10px; margin:12px 0}
    .block-checks label{display:flex; gap:12px; align-items:flex-start; background:#f8fafc; border:1px solid var(--line); padding:10px 12px; border-radius:12px; font-size:17px}
    .block-checks input{transform:translateY(2px)}

    /* общий прогресс */
    .progress{width:100%; height:12px; border-radius:999px; background:#f1f5f9; border:1px solid var(--line); overflow:hidden}
    .progress>span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); transition:width .35s ease}

    .progress-dock{position:fixed; right:16px; bottom:16px; z-index:999; width:min(420px,92vw);
      background:#ffffffee; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px 16px; backdrop-filter:blur(6px)}
    .progress-dock .head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .progress-dock .muted{color:var(--muted); font-size:14px}

    .btn{display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:14px;
      border:1px solid rgba(37,99,235,.35); background:rgba(37,99,235,.08); color:var(--text);
      text-decoration:none; font-weight:700; transition:transform .08s ease, background .2s ease, border-color .2s ease; font-size:17px}
    .btn:hover{transform:translateY(-1px); background:rgba(37,99,235,.12); border-color:rgba(37,99,235,.55)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    a{color:#1d4ed8} code,kbd{background:#f1f5f9; border:1px solid var(--line); padding:2px 6px; border-radius:8px}
    hr{border:none; border-top:1px solid var(--line); margin:24px 0} ul,ol{padding-left:24px}

    @media (max-width: 720px){ .doc{margin-bottom:170px} .toc{position:static} }
    /* Три изображения в один ряд для блока 0 */
.shots-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
@media (max-width: 980px){ .shots-3{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width: 640px){ .shots-3{ grid-template-columns: 1fr; } }

  </style>
</head>
  <script>
(function(){
  const $ = (q, el=document)=>el.querySelector(q);
  const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));

  /* ---------- TOC из h2 ---------- */
  const h2s = $$('main h2');
  if (h2s.length){
    const toc = document.createElement('nav');
    toc.className = 'toc';
    toc.setAttribute('aria-label','Оглавление');
    toc.innerHTML = '<h3>Оглавление</h3><div class="toc-links"></div>';
    const wrap = $('.doc') || document.body;
    wrap.prepend(toc);
    const linksWrap = $('.toc-links', toc);
    h2s.forEach(h=>{
      const id = h.id || h.textContent.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'');
      h.id = id;
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = h.textContent.replace(/^\d+\)\s*/,'');
      linksWrap.appendChild(a);
    });
    const obs = new IntersectionObserver((ents)=>{
      ents.forEach(ent=>{
        if(ent.isIntersecting){
          const id = ent.target.id;
          $$('.toc a').forEach(a=>a.classList.toggle('active', a.getAttribute('href') === '#'+id));
        }
      });
    }, {rootMargin:'-40% 0px -55% 0px', threshold: 0.01});
    h2s.forEach(h=>obs.observe(h));
  }

  /* ---------- Прогресс по ВСЕМ чекбоксам ---------- */
  const storageKey = 'quest_step1_checks_all';
  const bar = $('#progress-bar');
  const label = $('#progress-label');

  function getChecks(){ return $$('input[type="checkbox"]'); }

  function restore(){
    try{
      const saved = JSON.parse(localStorage.getItem(storageKey) || '[]');
      getChecks().forEach((c,i)=> c.checked = !!saved[i]);
    }catch(e){}
    update();
  }

  function save(){
    const arr = getChecks().map(c=> c.checked ? 1 : 0);
    localStorage.setItem(storageKey, JSON.stringify(arr));
  }

  function update(){
    const checks = getChecks();
    const done = checks.filter(c=>c.checked).length;
    const total = checks.length || 1;
    const pct = Math.round(done/total*100);
    if (bar) bar.style.width = pct + '%';
    if (label) label.textContent = pct + '% выполнено';
    const finish = $('#finish');
    if (finish) finish.disabled = pct < 100;
  }

  // Делегирование: ловим любое изменение чекбокса на странице
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.matches('input[type="checkbox"]')){
      save(); update();
    }
  });

  // Плавная прокрутка якорей
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[href^="#"]'); if(!a) return;
    const id = a.getAttribute('href').slice(1);
    const el = document.getElementById(id); if(!el) return;
    e.preventDefault();
    el.scrollIntoView({behavior:'smooth', block:'start'});
    history.replaceState(null, '', '#'+id);
  });

  // Восстановление после загрузки
  window.addEventListener('load', restore);
})();
</script>

<body>
  <a id="top"></a>

  <header class="hero">
    <div class="doc">
      <h1 class="title">Квест «Перекодировка через атрибуты»</h1>
      <p class="subtitle">Пошаговый гайд для Recode by attribute</p>
    </div>
  </header>

  <main class="doc">
    <!-- TOC генерируется скриптом по h2 -->

    <!-- 0) ЧТО ПОНАДОБИТСЯ — исходные тексты и изображения -->
   <section class="step" id="need">
  <h2>0) Что понадобится</h2>
  <ul>
    <li>Excel-таблица с колонками <code>code</code>, <code>text</code>, <code>new</code>.</li>
    <li>Доступ к конструктору на Синтезе.</li>
    <li>Браузер с включённым JavaScript.</li>
  </ul>

</section>


    <!-- 1) ТАБЛИЦА -->
    <section class="step" id="excel">
      <h2>1) Подготовьте таблицу в Excel с колонками <code>code</code>, <code>text</code>, <code>new</code></h2>
      <ol>
        <li>Создайте таблицу в Excel с тремя колонками: <code>code</code>, <code>text</code>, <code>new</code>. Чтобы конструктор распознал структуру, сохраняйте названия «code» и «text». Новые атрибуты называйте латиницей.</li>
        <li>Заполните 10 строк:
          <ul>
            <li>в <code>code</code> — исходные коды (1, 2, 3…),</li>
            <li>в <code>text</code> — подписи («тюльпан», «нарцисс», «яблоня»),</li>
            <li>в <code>new</code> — целевые категории (1 = «цветы», 2 = «деревья»).</li>
          </ul>
        </li>
      </ol>
      <p><strong>Принцип работы:</strong> исходные варианты объединяются в более крупные группы (например, «тюльпан» и «нарцисс» → «цветы», «яблоня» → «деревья»).</p>
      <div class="shots">
        <figure>
          <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/table.png" alt="Пример таблицы code / text / new">
          <figcaption>Пример структуры таблицы</figcaption>
        </figure>
      </div>
      <div class="block-checks" aria-label="Отметки блока 1">
        <label><input type="checkbox"> Файл Excel создан</label>
        <label><input type="checkbox"> 10 строк заполнены</label>
        <label><input type="checkbox"> Коды в колонке <code>new</code> указаны</label>
      </div>
    </section>

    <!-- 2) RAW -->
    <section class="step" id="raw">
      <h2>2) Вставьте таблицу в окне Raw</h2>
      <ol>
        <li>Создайте новый вопрос <code>q1</code> (Single Choice).</li>
        <li>Нажмите иконку <em>Raw</em>, чтобы сделать её активной.</li>
        <li>Удалите весь текст в окне и вставьте подготовленную таблицу, затем сохраните.</li>
      </ol>
      <div class="shots">
        <figure>
          <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/Raw.png" alt="Raw — пустое поле">
          <figcaption>Raw: пустое поле</figcaption>
        </figure>
        <figure>
          <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/Raw2.png" alt="Raw — вставленная таблица">
          <figcaption>Raw: таблица вставлена</figcaption>
        </figure>
      <div class="block-checks" aria-label="Отметки блока 2">
        <label><input type="checkbox"> Вопрос <code>q1</code> создан</label>
        <label><input type="checkbox"> Таблица вставлена в Raw</label>
        <label><input type="checkbox"> Изменения сохранены</label>
      </div>
    </section>

    <!-- 3) КОНСТРУКТОР -->
    <section class="step" id="constructor">
      <h2>3) Вернитесь в режим конструктора</h2>
      <p>Нажмите иконку Raw и убедитесь, что все строки считались. Атрибут <code>new</code> записан внутри вариантов ответов в <code>q1</code> (внешне список не меняется).</p>
      <div class="shots">
        <figure>
          <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/Raw3.png" alt="Список опций после вставки">
          <figcaption>Список опций в режиме конструктора</figcaption>
        </figure>
      </div>
      <div class="block-checks" aria-label="Отметки блока 3">
        <label><input type="checkbox"> Окно Raw закрыто</label>
        <label><input type="checkbox"> Изменения в <code>q1</code> сохранены</label>
      </div>
    </section>

    <!-- 4) Q2 -->
    <section class="step" id="q2">
      <h2>4) Создайте второй вопрос Single Choice (q2) с вариантами ответов из <code>new</code></h2>
      <ol>
        <li>Добавьте новый вопрос Single Choice — <code>q2</code>.</li>
        <li>Создайте варианты: 1 — «цветы», 2 — «деревья».</li>
      </ol>
      <div class="shots">
        <figure>
          <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/q2.png" alt="Вопрос q2: 1 цветы, 2 деревья">
          <figcaption>q2: целевые ответы</figcaption>
        </figure>
      </div>
      <div class="block-checks" aria-label="Отметки блока 4">
        <label><input type="checkbox"> Вопрос <code>q2</code> создан</label>
        <label><input type="checkbox"> Варианты из <code>new</code> добавлены</label>
      </div>
    </section>

    <!-- 5) RECODE -->
    <section class="step" id="recode">
      <h2>5) Настройте фильтр <em>recode by attribute</em> для <code>q2</code></h2>
      <ol>
        <li>Нажмите <em>Filter</em> <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/Filter.png" alt="Иконка Filter" style="display:inline;height:22px;vertical-align:middle;margin:0 6px;border-radius:6px">, затем «карандаш» <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/Edit.png" alt="Кнопка Edit" style="display:inline;height:22px;vertical-align:middle;margin:0 6px;border-radius:6px">.</li>
        <li>Выберите правило <em>Recode by attribute</em>.</li>
        <li>Укажите: <strong>from:</strong> <code>q1</code>, <strong>attribute:</strong> <code>new</code>.</li>
        <li>Сохраните правило.</li>
      </ol>
      <div class="shots">
        <figure>
          <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/Recode2.png" alt="Панель выбора правила Recode by attribute">
          <figcaption>Выбор правила</figcaption>
        </figure>
        <figure>
          <img src="https://raw.githubusercontent.com/scm1ok-source/quest/main/Recode3.png" alt="Заполненные параметры q1/new">
          <figcaption>Параметры: from q1, attribute new</figcaption>
        </figure>
      </div>
      <div class="block-checks" aria-label="Отметки блока 5">
        <label><input type="checkbox"> Открыт Filter → Edit</label>
        <label><input type="checkbox"> Выбрано правило «Recode by attribute»</label>
        <label><input type="checkbox"> Указаны from=<code>q1</code>, attribute=<code>new</code></label>
        <label><input type="checkbox"> Правило сохранено</label>
      </div>
    </section>

    <!-- 6) СКРЫТЬ Q2 -->
    <section class="step" id="hide-q2">
      <h2>6) Скройте вопрос <code>q2</code> от респондентов</h2>
      <ol>
        <li>Сделайте апдейт ссылки и проверьте корректность работы перекодировки.</li>
        <li>На панели логики выберите <strong>ASK NEVER</strong> и сохраните.</li>
      </ol>
      <div class="block-checks" aria-label="Отметки блока 6">
        <label><input type="checkbox"> Перекодировка работает корректно</label>
        <label><input type="checkbox"> <code>q2</code> скрыт (ASK NEVER)</label>
      </div>
    </section>

    <!-- ЧАСТЫЕ ОШИБКИ -->
    <section class="step" id="faq">
      <h2>Частые ошибки и быстрые решения</h2>
      <ul>
        <li><strong>Источник не тот.</strong> В <em>Select Option</em> должен быть выбран именно <code>q1</code>.</li>
        <li><strong>Опечатка в названии свойства.</strong> <code>new</code> должно совпадать до символа и регистра.</li>
        <li><strong>Нет вариантов из атрибута <code>new</code> в <code>q2</code>.</strong> Добавьте их вручную перед настройкой перекодировки.</li>
        <li><strong>Не все коды <code>new</code> указаны в <code>q2</code>.</strong> Если использовали 1..5, пропишите все 5 значений.</li>
      </ul>
    </section>

    <!-- ОБЩИЙ ЧЕК-ЛИСТ — перенесён в КОНЕЦ -->
    <section class="step" id="checklist">
      <h2>Итоговый чек-лист</h2>
      <div class="meta">Отметьте всё — и кнопка завершения станет активной</div>
      <div class="block-checks">
        <label><input type="checkbox"> Подготовлен Excel с колонками <code>code</code>, <code>text</code>, <code>new</code></label>
        <label><input type="checkbox"> Таблица вставлена в Raw и сохранена</label>
        <label><input type="checkbox"> Создан вопрос <code>q2</code> и добавлены коды из <code>new</code></label>
        <label><input type="checkbox"> Настроен фильтр <em>recode by attribute</em></label>
        <label><input type="checkbox"> <code>q2</code> скрыт (ASK NEVER), проверена работа</label>
      </div>
      <hr>
      <a id="finish" class="btn" href="#top" disabled>Квест пройден ✓</a>
      <p class="subtitle">Кнопка активируется автоматически, когда все чекбоксы отмечены.</p>
    </section>
  </main>

  <!-- Плавающий прогресс (fixed) -->
  <aside class="progress-dock" aria-live="polite" aria-label="Прогресс квеста">
    <div class="head">
      <strong>Прогресс квеста</strong>
      <span class="mute



